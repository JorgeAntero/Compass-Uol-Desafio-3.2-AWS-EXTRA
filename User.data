#!/bin/bash
exec > /var/log/user-data.log 2>&1
set -eux

dnf update -y
dnf install -y httpd

echo "Hello World" > /var/www/html/index.html

cat << 'EOF' > /var/www/cgi-bin/teste
#!/bin/bash
echo "Content-type: text/plain"
echo ""
echo "Requisição recebida em $(hostname)"
sleep 5
EOF

chmod +x /var/www/cgi-bin/teste

# Ativa CGI no Apache
echo 'ScriptAlias /teste /var/www/cgi-bin/teste' >> /etc/httpd/conf/httpd.conf
sed -i '/<Directory "\/var\/www\/cgi-bin">/,/<\/Directory>/ s/None/ExecCGI/' /etc/httpd/conf/httpd.conf
sed -i '/AddHandler cgi-script .cgi/ a AddHandler cgi-script .sh' /etc/httpd/conf/httpd.conf

systemctl enable --now httpd
